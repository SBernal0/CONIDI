{% extends 'base.html' %}
{% block title %}Gestionar Usuarios{% endblock %}

{% block content %}
<h2>Gestionar Usuarios</h2>
<hr>


{% if request.user.rol.nombre_rol|lower == 'administrador' %}
<div class="card mb-4">
    <div class="card-header">
        <h5>Crear Nuevo Administrador o Profesional</h5>
    </div>
    <div class="card-body">
        <form method="post" id="form-crear-usuario-directo">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_new">
            
            <div class="mb-3">
                <label for="rut" class="form-label">RUT</label>
                <input type="text" name="rut" class="form-control" value="{{ form_data.rut }}" required>
            </div>
            <div class="mb-3">
                <label for="nombre_completo" class="form-label">Nombre Completo</label>
                <input type="text" name="nombre_completo" class="form-control" value="{{ form_data.nombre_completo }}" required>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Correo Electrónico</label>
                <input type="email" name="email" class="form-control" value="{{ form_data.email }}" required>
            </div>
            <div class="mb-3">
                <label for="rol-select" class="form-label">Asignar Rol</label>
                <select name="rol_id" id="rol-select" class="form-select" required>
                    <option value="" disabled {% if not form_data.rol_id %}selected{% endif %}>-- Seleccione un rol --</option>
                    {% for rol in roles_para_crear %}
                        <option value="{{ rol.id }}" {% if form_data.rol_id == rol.id|stringformat:"s" %}selected{% endif %}>
                            {{ rol.nombre_rol }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nueva_clave" class="form-label">Contraseña</label>
                    <input type="password" name="nueva_clave" id="nueva_clave" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="confirmar_clave" class="form-label">Confirmar Contraseña</label>
                    <input type="password" name="confirmar_clave" id="confirmar_clave" class="form-control" required>
                    <small id="msg-clave" class="form-text"></small>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Crear Usuario</button>
        </form> </div>
</div>
{% endif %}


{% if tutores_para_activar %}
<div class="card">
    <div class="card-header">
        <h5>Activar Cuenta para Tutor Existente</h5>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="activate_tutor">
            <div class="mb-3">
                <label for="tutor-select" class="form-label">Tutores sin cuenta activa</label>
                <select name="tutor_rut" id="tutor-select" class="form-select" required>
                    <option></option> {% for tutor in tutores_para_activar %}
                        <option value="{{ tutor.rut }}">{{ tutor.nombre_completo }} (RUT: {{ tutor.rut }})</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-success">Activar Cuenta de Tutor</button>
        </form>
    </div>
</div>
{% elif request.user.rol.nombre_rol|lower == 'profesional' %}
    <div class="alert alert-info">No hay nuevos tutores para activar en este momento.</div>
{% endif %}

{% endblock %}


{% block extra_js %}
<script>
$(document).ready(function() {
    // Esto busca el <select> con el id 'tutor-select' y lo convierte
    $('#tutor-select').select2({
        placeholder: "Busca o selecciona un tutor por nombre o RUT",
        allowClear: true
    });
});

document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("form-crear-usuario-directo");
    if (form) {
        const nueva = document.getElementById("nueva_clave");
        const confirmar = document.getElementById("confirmar_clave");
        const msg = document.getElementById("msg-clave");

        function validarCoincidencia() {
            if (confirmar.value === "") {
                msg.textContent = "";
                confirmar.classList.remove("is-invalid", "is-valid");
                return;
            }
            if (nueva.value === confirmar.value) {
                msg.textContent = "Las contraseñas coinciden ✅";
                msg.className = "form-text text-success";
                confirmar.classList.remove("is-invalid");
                confirmar.classList.add("is-valid");
            } else {
                msg.textContent = "Las contraseñas no coinciden ❌";
                msg.className = "form-text text-danger";
                confirmar.classList.remove("is-valid");
                confirmar.classList.add("is-invalid");
            }
        }

        nueva.addEventListener("input", validarCoincidencia);
        confirmar.addEventListener("input", validarCoincidencia);

        form.addEventListener("submit", (e) => {
            if (nueva.value !== confirmar.value) {
                e.preventDefault();
                alert("Las contraseñas no coinciden. Por favor, corrígelas antes de enviar el formulario.");
            }
        });
    }
});
</script>
{% endblock %}