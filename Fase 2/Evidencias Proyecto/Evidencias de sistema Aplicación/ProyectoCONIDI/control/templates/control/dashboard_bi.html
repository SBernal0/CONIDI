{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard de Gestión - Inteligencia de Negocios{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header mb-4">
        <h2><i class="bi bi-graph-up-arrow me-2"></i>Dashboard de Gestión Clínica</h2>
        <p class="text-muted">Análisis de tendencias para la toma de decisiones estratégicas.</p>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-calendar-check me-2"></i>1. Tendencias de Asistencia (Adherencia)</h5>
            <span class="badge bg-light text-dark">Estacionalidad</span>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label small">Año Actual</label>
                    <select class="form-select form-select-sm">
                        <option>2025</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Comparar con</label>
                    <select class="form-select form-select-sm">
                        <option>Año Anterior (2024)</option>
                    </select>
                </div>
                <div class="col-md-6 text-end align-self-end">
                    <button class="btn btn-sm btn-outline-primary"><i class="bi bi-filter"></i> Aplicar Filtros</button>
                </div>
            </div>
            
            <div style="height: 300px;">
                <canvas id="chartAsistencia"></canvas>
            </div>
            <div class="mt-3 p-3 bg-light rounded border-start border-4 border-primary">
                <small><strong><i class="bi bi-lightbulb"></i> Insight:</strong> Se observa una caída del 15% en la asistencia durante el Q3 (Invierno) respecto al promedio anual, consistente con el patrón del año anterior.</small>
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>2. Estado Nutricional Comparativo (Anual)</h5>
            <span class="badge bg-light text-dark">Evolución Salud</span>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label small">Grupo Etario</label>
                    <select class="form-select form-select-sm">
                        <option>Todos</option>
                        <option>0 - 24 meses</option>
                        <option>2 - 5 años</option>
                        <option>5 - 9 años</option>
                    </select>
                </div>
                 <div class="col-md-3">
                    <label class="form-label small">Indicador</label>
                    <select class="form-select form-select-sm">
                        <option>Diagnóstico Nutricional Integrado</option>
                        <option>IMC</option>
                    </select>
                </div>
            </div>
            
            <div style="height: 300px;">
                <canvas id="chartNutricional"></canvas>
            </div>
             <div class="mt-3 p-3 bg-light rounded border-start border-4 border-success">
                <small><strong><i class="bi bi-lightbulb"></i> Insight:</strong> La obesidad en el grupo de 2-5 años ha disminuido un 5% respecto al 2023, sugiriendo un impacto positivo de las intervenciones educativas.</small>
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>3. Cobertura de Vacunación por Sector</h5>
            <span class="badge bg-light text-dark">Gestión Territorial</span>
        </div>
        <div class="card-body">
             <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label small">Vacuna / Programa</label>
                    <select class="form-select form-select-sm">
                        <option>Programa General (PNI)</option>
                        <option>Influenza (Campaña)</option>
                        <option>SARS-CoV-2</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <div style="height: 300px;">
                        <canvas id="chartVacunacion"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                     <div class="card h-100 border-0 bg-light">
                        <div class="card-body">
                            <h6>Resumen por Sector</h6>
                            <ul class="list-group list-group-flush bg-transparent">
                                <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center">
                                    Sector Rojo
                                    <span class="badge bg-danger rounded-pill">Baja (78%)</span>
                                </li>
                                <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center">
                                    Sector Azul
                                    <span class="badge bg-warning text-dark rounded-pill">Media (85%)</span>
                                </li>
                                <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center">
                                    Sector Verde
                                    <span class="badge bg-success rounded-pill">Alta (92%)</span>
                                </li>
                            </ul>
                             <div class="mt-3 p-2 border rounded bg-white">
                                <small class="text-muted"><strong>Acción sugerida:</strong> Reforzar equipo móvil en Sector Rojo para la próxima semana.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- GRÁFICO 1: TENDENCIAS DE ASISTENCIA (Línea Comparativa) ---
    const ctxAsistencia = document.getElementById('chartAsistencia');
    new Chart(ctxAsistencia, {
        type: 'line',
        data: {
            labels: ['Q1 (Ene-Mar)', 'Q2 (Abr-Jun)', 'Q3 (Jul-Sep)', 'Q4 (Oct-Dic)'],
            datasets: [
                {
                    label: 'Asistencia 2025 (Actual)',
                    data: [85, 82, 68, null], // Q4 null porque no ha pasado
                    borderColor: '#0d6efd',
                    backgroundColor: '#0d6efd',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'Asistencia 2024 (Anterior)',
                    data: [80, 79, 65, 78],
                    borderColor: '#adb5bd',
                    borderDash: [5, 5], // Línea punteada para comparar
                    tension: 0.3,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: { 
                    beginAtZero: false, 
                    min: 50, max: 100,
                    title: { display: true, text: '% Adherencia' }
                }
            }
        }
    });

    // --- GRÁFICO 2: ESTADO NUTRICIONAL (Barras Apiladas Comparativas) ---
    const ctxNutricional = document.getElementById('chartNutricional');
    new Chart(ctxNutricional, {
        type: 'bar',
        data: {
            labels: ['2023', '2024', '2025 (Parcial)'],
            datasets: [
                {
                    label: 'Desnutrición',
                    data: [5, 4, 3],
                    backgroundColor: '#dc3545',
                },
                {
                    label: 'Normal',
                    data: [60, 65, 68],
                    backgroundColor: '#198754',
                },
                {
                    label: 'Sobrepeso',
                    data: [20, 18, 17],
                    backgroundColor: '#ffc107',
                },
                 {
                    label: 'Obesidad',
                    data: [15, 13, 12],
                    backgroundColor: '#fd7e14',
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true },
                y: { 
                    stacked: true, 
                    max: 100,
                    title: { display: true, text: '% Población Control' }
                }
            }
        }
    });

    // --- GRÁFICO 3: COBERTURA POR SECTOR (Radar o Barras) ---
    const ctxVacunacion = document.getElementById('chartVacunacion');
    new Chart(ctxVacunacion, {
        type: 'bar',
        data: {
            labels: ['Sector Rojo', 'Sector Azul', 'Sector Verde', 'Sector Amarillo'],
            datasets: [
                {
                    label: 'Cobertura 2025',
                    data: [78, 85, 92, 88],
                    backgroundColor: [
                        'rgba(220, 53, 69, 0.7)', // Rojo (Bajo)
                        'rgba(255, 193, 7, 0.7)', // Amarillo (Medio)
                        'rgba(25, 135, 84, 0.7)', // Verde (Alto)
                        'rgba(25, 135, 84, 0.7)'
                    ],
                    borderColor: [
                        'rgb(220, 53, 69)',
                        'rgb(255, 193, 7)',
                        'rgb(25, 135, 84)',
                        'rgb(25, 135, 84)'
                    ],
                    borderWidth: 1
                },
                {
                    label: 'Meta Ministerial (90%)',
                    data: [90, 90, 90, 90],
                    type: 'line', // Línea de meta
                    borderColor: 'black',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }
            ]
        },
        options: {
            indexAxis: 'y', // Barras horizontales
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { 
                    max: 100,
                    title: { display: true, text: '% Cobertura' }
                }
            }
        }
    });

});
</script>
{% endblock %}