{% extends 'base.html' %}
{% load static %}
 
{% block title %}Configurar y Enviar Reportes{% endblock %}
 
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/estiloformularios.css' %}">
{% endblock %}
 
{% block content %}
 
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">
 
            <div class="card form-card mb-4">
                <div class="form-header">
                    <div class="form-icon"><i class="bi bi-people-fill"></i></div>
                    <h2>Encargados Actuales de Reportes</h2>
                </div>
                <div class="form-body">
                    {% if encargados_actuales %}
                        <ul class="list-group">
                            {% for encargado in encargados_actuales %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-person-check-fill me-2"></i>
                                        <strong>{{ encargado.nombre_completo }}</strong>
                                        <small class="text-muted ms-2">({{ encargado.email }})</small>
                                    </div>
                                    <form method="post" class="mb-0">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="remover_encargado">
                                        <input type="hidden" name="encargado_rut" value="{{ encargado.rut }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Remover de la lista de encargados">
                                            <i class="bi bi-person-x-fill"></i> Remover
                                        </button>
                                    </form>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            Actualmente no hay profesionales encargados de recibir reportes.
                        </div>
                    {% endif %}
                </div>
            </div>
 
            <div class="card form-card mb-4"> 
                <div class="form-header">
                    <div class="form-icon"><i class="bi bi-person-plus-fill"></i></div>
                    <h2>Agregar Encargados</h2>
                </div>
                <div class="form-body">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="agregar_encargados">
                        <div class="mb-3">
                            <label for="profesionales_a_agregar" class="form-label">Buscar y seleccionar uno o más profesionales para agregar como encargados:</label>
                            <select name="profesionales_a_agregar" id="profesionales_a_agregar" class="form-select select2-multiple" multiple>
                                {% for prof in profesionales_no_encargados %}
                                    <option value="{{ prof.rut }}">{{ prof.nombre_completo }}</option>
                                {% empty %}
                                    <option disabled>No hay más profesionales para agregar.</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Utilice el campo de búsqueda para encontrar y seleccionar profesionales.</small>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn btn-primary" {% if not profesionales_no_encargados %}disabled{% endif %}>
                                <i class="bi bi-plus-circle-fill me-2"></i>Agregar Seleccionados
                            </button>
                        </div>
                    </form>
                </div>
            </div>
 
            <div class="card form-card">
                <div class="form-header">
                    <div class="form-icon"><i class="bi bi-envelope-paper-fill"></i></div>
                    <h2>Enviar Reporte Manual</h2>
                </div>
                <div class="form-body">
                    <p>Envíe un reporte inmediato con el listado de niños con controles de salud atrasados a todos los profesionales encargados.</p>
                    {% if encargados_actuales %}
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="enviar_reporte">
                            <div class="form-buttons">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-send-fill me-2"></i>Enviar Reporte a {{ encargados_actuales|length }} Encargado(s)
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <div class="alert alert-warning text-center">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Debe asignar al menos un profesional encargado para poder enviar el reporte.
                        </div>
                        <div class="form-buttons">
                            <button class="btn btn-success" disabled>
                                <i class="bi bi-send-fill me-2"></i>Enviar Reporte
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
 
        </div>
    </div>
</div>
 
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Inicializar Select2 en el campo de selección múltiple
        $('#profesionales_a_agregar').select2({
            placeholder: "Buscar y seleccionar profesionales...", // Texto de placeholder
            allowClear: true, // Permite deseleccionar todos los elementos
            language: {
                noResults: function() {
                    return "No se encontraron resultados";
                },
                searching: function() {
                    return "Buscando...";
                }
            }
        });
    });
</script>
{% endblock %}