{% extends 'base.html' %}
{% load static %}

{% block title %}Controles de {{ nino.nombre }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/estilocontroles.css' %}">
{% endblock %}

{% block content %}




<div class="page-header mb-4">
    <h2><i class="bi bi-heart-pulse-fill me-2"></i>Controles y Seguimiento</h2>
    <p class="child-info">
        <strong>Niño/a:</strong> {{ nino.nombre }} {{ nino.ap_paterno }} {{ nino.ap_materno }} |
        <strong>RUT:</strong> {{ nino.rut_nino }} |
        <strong>Nacimiento:</strong> {{ nino.fecha_nacimiento|date:"d/m/Y" }}
    </p>
</div>

<ul class="nav nav-tabs" id="controlTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="resumen-tab" data-bs-toggle="tab" data-bs-target="#resumen-pane" type="button" role="tab" aria-controls="resumen-pane" aria-selected="true">
            <i class="bi bi-person-lines-fill me-1"></i> Resumen General
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="controles-tab" data-bs-toggle="tab" data-bs-target="#controles-pane" type="button" role="tab" aria-controls="controles-pane" aria-selected="false">
            <i class="bi bi-clipboard2-pulse me-1"></i> Controles Niño Sano
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="vacunas-tab" data-bs-toggle="tab" data-bs-target="#vacunas-pane" type="button" role="tab" aria-controls="vacunas-pane" aria-selected="false">
            <i class="bi bi-shield-plus me-1"></i> Historial Vacunación
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="alergias-tab" data-bs-toggle="tab" data-bs-target="#alergias-pane" type="button" role="tab" aria-controls="alergias-pane" aria-selected="false">
            <i class="bi bi-bandaid me-1"></i> Alergias Registradas
        </button>
    </li>
    {# --- PESTAÑA GESTIÓN (SOLO PARA PROFESIONAL/ADMIN) --- #}
    {% if request.user.rol.nombre_rol|lower in "administrador,profesional" %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="gestion-tab" data-bs-toggle="tab" data-bs-target="#gestion-pane" type="button" role="tab" aria-controls="gestion-pane" aria-selected="false">
            <i class="bi bi-pencil-square me-1"></i> Gestión
        </button>
    </li>
    {% endif %}
    </ul> <div class="tab-content" id="controlTabsContent">
</ul>

<div class="tab-content" id="controlTabsContent">


    <div class="tab-pane fade show active" id="resumen-pane" role="tabpanel" aria-labelledby="resumen-tab" tabindex="0">
        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card summary-card">
                    <div class="card-header"><i class="bi bi-person-vcard me-2"></i>Datos Personales</div>
                    <div class="card-body">
                        <p><strong>RUT:</strong> {{ nino.rut_nino }}</p>
                        <p><strong>Sexo:</strong> {{ nino.sexo }}</p>
                        <p><strong>Dirección:</strong> {{ nino.direccion|default:"No registrada" }}</p>
                        <p><strong>Comuna:</strong> {{ nino.comuna.nom_comuna }}</p>
                        <p><strong>Sector:</strong> {{ nino.sector|default:"No asignado" }}</p>
                        <p><strong>Estado Seguimiento:</strong> {{ nino.get_estado_seguimiento_display }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card summary-card">
                    <div class="card-header"><i class="bi bi-clipboard2-pulse-fill me-2"></i>Último Control Registrado</div>
                    <div class="card-body">
                        {% if ultimo_control %}
                            <p><strong>Tipo:</strong> {{ ultimo_control.nombre_control }}</p>
                            <p><strong>Fecha Realización:</strong> {{ ultimo_control.fecha_realizacion_control|date:"d/m/Y" }}</p>
                            <p><strong>Peso:</strong> {{ ultimo_control.pesokg|default:"N/R" }} kg</p>
                            <p><strong>Talla:</strong> {{ ultimo_control.talla_cm|default:"N/R" }} cm</p>
                            <p><strong>IMC:</strong> {{ ultimo_control.imc|default:"N/R" }}</p>
                            <p><strong>Calif. Nutricional:</strong> {{ ultimo_control.calificacion_nutricional|default:"N/R" }}</p>
                            <a href="{% url 'control:ver_control' ultimo_control.id %}" class="btn btn-sm btn-outline-primary mt-2">
                                <i class="bi bi-eye me-1"></i> Ver Detalles del Control
                            </a>
                        {% else %}
                            <p class="text-muted">Aún no se ha registrado ningún control para este niño/a.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-lg-4 col-md-6 mb-3">
                <div class="card summary-card">
                    <div class="card-header"><i class="bi bi-graph-up me-2"></i>Curva de Peso (kg)</div>
                    <div class="card-body" style="position: relative; height: 300px;">
                        <canvas id="graficoPeso"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-3">
                <div class="card summary-card">
                    <div class="card-header"><i class="bi bi-graph-up me-2"></i>Curva de Talla (cm)</div>
                    <div class="card-body" style="position: relative; height: 300px;">
                        <canvas id="graficoTalla"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-12 mb-3">
                <div class="card summary-card">
                    <div class="card-header"><i class="bi bi-graph-up me-2"></i>Curva de IMC</div>
                    <div class="card-body" style="position: relative; height: 300px;">
                        <canvas id="graficoIMC"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    {# --- Pestaña Controles Niño Sano --- #}
    <div class="tab-pane fade" id="controles-pane" role="tabpanel" aria-labelledby="controles-tab" tabindex="0">
        <div class="item-grid-container mt-3">
            {% for control in controles %}
            {# Añadimos una clase extra si está deshabilitado para atenuarlo #}
            <div class="info-block animate-list-item {% if control.deshabilitado %}disabled-item{% endif %}" style="--i: {{ forloop.counter0 }};">
                <div class="list-item-header">
                    <h5>{{ control.nombre_control }}</h5>
                    <span class="badge {{ control.estado_css_class }} rounded-pill">
                        {{ control.estado_alerta }} {# Ahora mostrará "Deshabilitado" #}
                    </span>
                </div>
                <div class="list-item-content">
                    <p><strong>Fecha Programada:</strong> {{ control.fecha_control_programada|date:"d/m/Y" }}</p>
                    {% if control.estado_alerta == "Realizado" %}
                        <small class="text-success mt-1 d-block">Realizado el: {{ control.fecha_realizacion_control|date:"d/m/Y" }}</small>
                    {% elif control.deshabilitado %}
                        <small class="text-muted mt-1 d-block">Control marcado como no aplicable o no realizado.</small>
                    {% endif %}
                </div>
                <div class="list-item-actions">
                    {# --- LÓGICA DE BOTONES ACTUALIZADA --- #}
                    {% if control.estado_alerta == "Realizado" %}
                        {# Si está realizado, mostramos Ver y Editar #}
                        <a href="{% url 'control:ver_control' control.id %}" class="btn btn-sm btn-info text-white"><i class="bi bi-eye-fill me-1"></i> Ver</a>
                        {% if request.user.rol.nombre_rol|lower in "administrador,profesional" %}
                            <a href="{% url 'control:editar_control' control.id %}" class="btn btn-sm btn-warning"><i class="bi bi-pencil-fill me-1"></i> Editar</a>
                        {% endif %}
                    {% elif control.deshabilitado %}
                        {# Si está deshabilitado, solo permitimos Editar (para reactivar) #}
                        {% if request.user.rol.nombre_rol|lower in "administrador,profesional" %}
                            <a href="{% url 'control:editar_control' control.id %}" class="btn btn-sm btn-secondary"><i class="bi bi-pencil-fill me-1"></i> Editar/Reactivar</a>
                        {% endif %}
                        {# Opcional: Podrías añadir un botón para ver el historial aquí si quieres #}
                        {% if request.user.rol.nombre_rol|lower == 'administrador' %}
                            {# <a href="{% url 'control:historial_control' control.id %}" class="btn btn-sm btn-outline-info">Historial</a> #}
                        {% endif %}
                    {% elif request.user.rol.nombre_rol|lower in "administrador,profesional" %}
                        {# Si está pendiente/atrasado, mostramos Registrar #}
                        <a href="{% url 'control:registrar_control' control.id %}" class="btn btn-sm btn-success"><i class="bi bi-plus-circle-fill me-1"></i> Registrar</a>
                    {% endif %}
                </div>
            </div>
            {% empty %}
                <div class="alert alert-light w-100 text-center">No hay controles programados para este niño/a.</div>
            {% endfor %}
        </div>
    </div>
    <div class="tab-pane fade show active" id="resumen-pane" role="tabpanel" aria-labelledby="resumen-tab" tabindex="0">
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="card summary-card">
                </div>
        </div>
        <div class="col-md-6">
            <div class="card summary-card">
                </div>
        </div>
    </div>
    
    
    </div>

    {# --- Pestaña Historial de Vacunación --- #}
    <div class="tab-pane fade" id="vacunas-pane" role="tabpanel" aria-labelledby="vacunas-tab" tabindex="0">
        <div class="item-grid-container mt-3"> 
            {% for vacuna_app in vacunas_aplicadas %}
            <div class="info-block animate-list-item {% if vacuna_app.deshabilitado %}disabled-item{% endif %}" style="--i: {{ forloop.counter0 }};"> 
                <div class="list-item-header">
                    <h5>{{ vacuna_app.vacuna.nom_vacuna }}</h5>
                    <span class="badge {{ vacuna_app.estado_css_class }} rounded-pill">
                        {{ vacuna_app.estado_alerta }}
                    </span>
                </div>
                <div class="list-item-content">
                    <p><strong>Fecha Programada:</strong> {{ vacuna_app.fecha_programada|date:"d/m/Y" }}</p>
                    {% if vacuna_app.fecha_aplicacion %}
                        <small class="text-success mt-1 d-block">Aplicada el: {{ vacuna_app.fecha_aplicacion|date:"d/m/Y" }}</small>
                    {% elif vacuna_app.deshabilitado %}
                        <small class="text-muted mt-1 d-block">Vacuna marcada como no aplicable.</small>
                    {% endif %}
                </div>
                <div class="list-item-actions">
                    {% if vacuna_app.fecha_aplicacion %}
                        <a href="{% url 'control:ver_vacuna' vacuna_app.id %}" class="btn btn-sm btn-info text-white"><i class="bi bi-eye-fill me-1"></i> Ver</a>
                        {% if request.user.rol.nombre_rol|lower in "administrador,profesional" %}
                            <a href="{% url 'control:editar_vacuna' vacuna_app.id %}" class="btn btn-sm btn-warning"><i class="bi bi-pencil-fill me-1"></i> Editar</a>
                        {% endif %}
                    {% elif vacuna_app.deshabilitado %}
                        {% if request.user.rol.nombre_rol|lower in "administrador,profesional" %}
                            <a href="{% url 'control:editar_vacuna' vacuna_app.id %}" class="btn btn-sm btn-secondary"><i class="bi bi-pencil-fill me-1"></i> Editar/Reactivar</a>
                        {% endif %}
                    {% else %}
                        {% if request.user.rol.nombre_rol|lower in "administrador,profesional" %}
                            <a href="{% url 'control:registrar_vacuna' vacuna_app.id %}" class="btn btn-sm btn-success"><i class="bi bi-plus-circle-fill me-1"></i> Registrar</a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% empty %}
                <div class="alert alert-light w-100 text-center">El calendario de vacunación para este niño/a aún no ha sido generado.</div>
            {% endfor %}
        </div>
    </div>

    {# --- Pestaña Alergias Registradas --- #}
    <div class="tab-pane fade" id="alergias-pane" role="tabpanel" aria-labelledby="alergias-tab" tabindex="0">
    {# Botón flotante o fijo para añadir alergia #}
    <div class="text-end my-3"> {# Contenedor para alinear el botón a la derecha #}
        {% if request.user.rol.nombre_rol|lower in "administrador,profesional" %}
            <a href="{% url 'control:registrar_alergia' nino.rut_nino %}" class="btn btn-warning btn-sm">
                <i class="bi bi-plus-lg me-1"></i> Registrar Nueva Alergia
            </a>
        {% endif %}
    </div>

    <div class="item-grid-container"> 
        {% for registro in alergias_registradas %}
         <div class="info-block animate-list-item" style="--i: {{ forloop.counter0 }};"> 
             <div class="list-item-header">
                 <h5>{{ registro.agente_especifico }}</h5>
                 <small class="text-muted">Detectada: {{ registro.fecha_aparicion|date:"d/m/Y" }}</small>
             </div>
             <div class="list-item-content">
                {# Mostramos la categoría y el mecanismo #}
                <small class="text-secondary d-block mb-1">
                    {{ registro.categoria.nombre }} - {{ registro.get_mecanismo_inmunitario_display }}
                </small>
                <p class="mb-1">{{ registro.observaciones|default:"Sin observaciones."|truncatewords:20 }}</p>
                 {% if registro.fecha_remision %}
                     <small class="text-success d-block">Remitida: {{ registro.fecha_remision|date:"d/m/Y" }}</small>
                 {% else %}
                     <small class="text-danger d-block">Alergia activa.</small>
                 {% endif %}
             </div>
             <div class="list-item-actions">
                 {% if request.user.rol.nombre_rol|lower in "administrador,profesional" %}
                     <a href="{% url 'control:editar_alergia' registro.id %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil me-1"></i> Editar</a>
                     {% if request.user.rol.nombre_rol|lower == 'administrador' %}
                         <a href="{% url 'control:historial_alergia' registro.id %}" class="btn btn-sm btn-outline-info"><i class="bi bi-clock-history me-1"></i> Historial</a>
                     {% endif %}
                 {% endif %}
             </div>
         </div>
        {% empty %}
             <div class="alert alert-light w-100 text-center">No se han registrado alergias para este niño/a.</div>
        {% endfor %}
    </div>
    </div>
    {# --- PESTAÑA GESTIÓN (SOLO PARA PROFESIONAL/ADMIN) --- #}
    {% if request.user.rol.nombre_rol|lower in "administrador,profesional" %}
    <div class="tab-pane fade" id="gestion-pane" role="tabpanel" aria-labelledby="gestion-tab" tabindex="0">
        <div class="card summary-card mt-3 border-danger"> <div class="card-header bg-danger text-white"><i class="bi bi-shield-lock-fill me-2"></i>Zona de Gestión Administrativa</div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Atención:</strong> Está a punto de modificar datos sensibles del paciente (Estado, Fallecimiento). 
                    Esta acción requiere confirmación de identidad.
                </div>
                
                <form method="post" action="{% url 'control:detalle_nino' nino.rut_nino %}">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="estado_seguimiento" class="form-label">Estado del Seguimiento</label>
                            <select id="estado_seguimiento" name="estado_seguimiento" class="form-select" required>
                                {% for value, display in estado_seguimiento_choices %}
                                    <option value="{{ value }}" {% if nino.estado_seguimiento == value %}selected{% endif %}>{{ display }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sector" class="form-label">Sector Asignado</label>
                            <input type="text" class="form-control" id="sector" name="sector" value="{{ nino.sector|default:'' }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fecha_fallecimiento" class="form-label">Fecha de Fallecimiento</label>
                            <input type="date" class="form-control" id="fecha_fallecimiento" name="fecha_fallecimiento" value="{{ nino.fecha_fallecimiento|date:'Y-m-d' }}">
                            <small class="form-text text-muted">Dejar en blanco si no aplica.</small>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="password_confirm" class="form-label fw-bold text-danger">Confirme su contraseña para guardar:</label>
                            <div class="input-group">
                                <span class="input-group-text bg-danger text-white"><i class="bi bi-key-fill"></i></span>
                                <input type="password" class="form-control" id="password_confirm" name="password_confirm" required placeholder="Ingrese su contraseña actual">
                            </div>
                        </div>
                    </div>
                    <hr>
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-save me-1"></i> Autorizar y Guardar Cambios
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

</div> {% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    
    // --- 1. Preparamos TODOS los controles del niño ---
    const todosLosControles = [
        {% for control in controles %}
            {% if not control.deshabilitado and control.periodo %}
            {
                fecha: "{% if control.fecha_realizacion_control %}{{ control.fecha_realizacion_control|date:'Y-m-d' }}{% else %}{{ control.fecha_control_programada|date:'Y-m-d' }}{% endif %}",
                meses: {{ control.periodo.mes_control }},
                peso_real: {{ control.pesokg|default:"null" }},
                talla_real: {{ control.talla_cm|default:"null" }},
                imc_real: {{ control.imc|default:"null" }}
            },
            {% endif %}
        {% endfor %}
    ];
    
    todosLosControles.sort((a, b) => new Date(a.fecha.replace(/-/g, '/')) - new Date(b.fecha.replace(/-/g, '/')));

    // --- 2. Funciones para simular el P50 (Promedio) ---
    function getPesoPromedio(meses) {
        if (meses <= 12) return (3.5 + (meses * 0.7)).toFixed(1);
        else return (11.9 + ((meses - 12) * 0.21)).toFixed(1);
    }
    
    function getTallaPromedio(meses) {
        if (meses <= 12) return (50 + (meses * 2.5)).toFixed(1);
        else return (80 + ((meses - 12) * 0.5)).toFixed(1);
    }
    
    function getIMCPromedio(meses) {
        if (meses <= 6) return (17.5 - (meses * 0.2)).toFixed(1);
        if (meses <= 24) return (16.3 + ((meses - 6) * 0.01)).toFixed(1);
        if (meses <= 72) return (15.5 - ((meses - 24) * 0.03)).toFixed(1); 
        return (15.0 + ((meses - 72) * 0.05)).toFixed(1);
    }
    
    // --- 3. Creamos los arrays de datos para los gráficos ---
    const labels = [];
    const dataPesoReal = [];
    const dataPesoPromedio = [];
    const dataTallaReal = [];
    const dataTallaPromedio = [];
    const dataIMCReal = [];
    const dataIMCPromedio = [];

    for (const control of todosLosControles) {
        const fechaLabel = new Date(control.fecha.replace(/-/g, '/')).toLocaleDateString('es-CL');
        labels.push(fechaLabel);
        
        dataPesoReal.push(control.peso_real);
        dataTallaReal.push(control.talla_real);
        dataIMCReal.push(control.imc_real);
        
        dataPesoPromedio.push(getPesoPromedio(control.meses));
        dataTallaPromedio.push(getTallaPromedio(control.meses));
        dataIMCPromedio.push(getIMCPromedio(control.meses));
    }

    // --- 4. Función genérica para dibujar un gráfico ---
    function crearGrafico(canvasId, labelReal, dataReal, labelPromedio, dataPromedio, colorReal, ejeYLabel) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return; // Si no encuentra el canvas, no hace nada

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: labelReal,
                        data: dataReal,
                        borderColor: colorReal,
                        backgroundColor: colorReal.replace(')', ', 0.1)'), // Añade transparencia
                        tension: 0.1,
                        spanGaps: true,
                        fill: true
                    },
                    {
                        label: labelPromedio,
                        data: dataPromedio,
                        borderColor: 'rgba(150, 150, 150, 0.7)',
                        borderDash: [5, 5],
                        tension: 0.1,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: ejeYLabel }
                    }
                }
            }
        });
    }

    // --- 5. Dibujamos los 3 gráficos ---
    crearGrafico('graficoPeso', 'Peso del Niño (kg)', dataPesoReal, 'Peso Promedio (P50)', dataPesoPromedio, 'rgb(75, 192, 192)', 'Peso (kg)');
    crearGrafico('graficoTalla', 'Talla del Niño (cm)', dataTallaReal, 'Talla Promedio (P50)', dataTallaPromedio, 'rgb(255, 99, 132)', 'Talla (cm)');
    crearGrafico('graficoIMC', 'IMC del Niño', dataIMCReal, 'IMC Promedio (P50)', dataIMCPromedio, 'rgb(54, 162, 235)', 'Valor de IMC');
});
</script>
{% endblock extra_js %}